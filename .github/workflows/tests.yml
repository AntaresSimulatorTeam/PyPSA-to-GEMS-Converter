name: Tests

on:
  push:
    branches: ['**']
  pull_request:
    branches: ['**']
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-22.04

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements-dev.txt

    - name: Set Antares version from dependencies.json
      id: antares
      run: |
        v=$(python -c "import json; d=json.load(open('dependencies.json')); print(d.get('antares_version', '9.3.5'))")
        echo "version=${v}" >> $GITHUB_OUTPUT
        echo "dir=antares-${v}-Ubuntu-22.04" >> $GITHUB_OUTPUT

    - name: Download and extract Antares
      run: |
        v="${{ steps.antares.outputs.version }}"
        d="${{ steps.antares.outputs.dir }}"
        curl -OLs "https://github.com/AntaresSimulatorTeam/Antares_Simulator/releases/download/v${v}/${d}.tar.gz"
        tar -xzf "${d}.tar.gz" && rm -f "${d}.tar.gz"

    - name: Run end-to-end tests
      run: |
        python -m pytest -n auto tests/e2e/end_2_end_tests.py -v -s --log-cli-level=INFO --tb=short -rA

    - name: Run unit tests
      run: |
        python -m pytest -n auto tests/unit_tests/ -v -s --log-cli-level=INFO --tb=short -rA

    - name: Cleanup
      if: always()
      run: rm -rf ${{ steps.antares.outputs.dir }}
